# MQTT Broker Project with Dockerized Clients

This project implements a **simplified MQTT broker** in C with a fully containerized environment for testing multiple clients and measuring CPU and network metrics.

It uses **MQTT 5.0** protocol basics and allows clients to publish/subscribe to topics, while metrics are collected, analyzed, and visualized via Python scripts.

---

## ðŸ“‘ Table of Contents

- [MQTT Broker Project with Dockerized Clients](#mqtt-broker-project-with-dockerized-clients)
  - [ðŸ“‘ Table of Contents](#-table-of-contents)
  - [Project Overview](#project-overview)
  - [Directory Structure](#directory-structure)
    - [Important Directories](#important-directories)
  - [Logging System](#logging-system)
  - [Containerized Broker and Clients](#containerized-broker-and-clients)
    - [Broker Container](#broker-container)
    - [Client Container](#client-container)
  - [Metrics Collection and Plotting](#metrics-collection-and-plotting)
  - [Compilation and Execution](#compilation-and-execution)
  - [Limitations](#limitations)

---

## Project Overview

This project builds upon a basic TCP echo server and adapts it to handle MQTT protocol communication.

Features include:

- Multiple clients connecting simultaneously.
- Topic subscription management.
- Message publication and forwarding to subscribers.
- Commands handled: `CONNECT`, `SUBSCRIBE`, `PUBLISH`, `DISCONNECT`, `PINGREQ`.
- Persistence of clients and topics in `state/topics_state.json`.
- Metrics collection and visualization for CPU and network usage.

---

## Directory Structure

```
.
â”œâ”€â”€ LICENSE.txt
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ analysis
â”‚   â”œâ”€â”€ data/                  # CSV files generated by metrics collection
â”‚   â”œâ”€â”€ images/                # Plots generated by Python script
â”‚   â”œâ”€â”€ plot_metrics.py        # Python script to aggregate and plot metrics
â”‚   â””â”€â”€ requirements.txt       # Python dependencies
â”œâ”€â”€ bin/                        # Compiled broker executable
â”œâ”€â”€ build/                      # Object files from compilation
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile.broker       # Broker Dockerfile
â”‚   â””â”€â”€ Dockerfile.client       # Client Dockerfile
â”œâ”€â”€ include/                    # Header files
â”‚   â”œâ”€â”€ broker.h
â”‚   â”œâ”€â”€ client.h
â”‚   â”œâ”€â”€ config.h
â”‚   â”œâ”€â”€ mqtt_parser.h
â”‚   â”œâ”€â”€ topic.h
â”‚   â””â”€â”€ utils.h
â”œâ”€â”€ logs/                       # Broker logs
â”œâ”€â”€ scripts/                    # Scripts for automation
â”‚   â”œâ”€â”€ collect_metrics.sh
â”‚   â”œâ”€â”€ entrypoint_client.sh
â”‚   â””â”€â”€ launch.sh               # Launch script for tmux with broker and clients
â”œâ”€â”€ src/                        # Source code
â”‚   â”œâ”€â”€ broker.c
â”‚   â”œâ”€â”€ client.c
â”‚   â”œâ”€â”€ main.c
â”‚   â”œâ”€â”€ mqtt_parser.c
â”‚   â”œâ”€â”€ topic.c
â”‚   â””â”€â”€ utils.c
â””â”€â”€ state/                      # Persistent state for topics and clients
    â””â”€â”€ topics_state.json
```

### Important Directories

- **analysis/**: Contains metrics CSVs, generated plots, and Python scripts for aggregation.
- **docker/**: Dockerfiles for broker and client containers.
- **logs/**: Broker logs are exported here from the container.
- **state/**: JSON file storing persistent client and topic state.

---

## Logging System

The broker uses a **robust logging system**:

- Messages are categorized into `DEBUG`, `INFO`, `WARN`, `ERROR`.
- Color-coded output in console.
- Logs are exported to `logs/broker.log`.
- **Debug mode** can be toggled via `config.h` (`DEBUG_ENABLED`), default is OFF.

This ensures traceability of client interactions, subscriptions, and published messages.

---

## Containerized Broker and Clients

### Broker Container

- Dockerfile builds an image containing all dependencies and compiles the broker via `make`.
- Maps `state/` and `logs/` directories to host for persistence.
- Example run:

```bash
docker run --name broker --network mqtt_net -p 8000:8000 \
    -v $(pwd)/state:/app/state \
    -v $(pwd)/logs:/app/logs mybroker
```

### Client Container

- Dockerfile installs `mosquitto-clients` and copies `entrypoint_client.sh`.
- Clients connect to the broker inside the same Docker network.
- Example run:

```bash
docker run -it --rm --name mqtt_clients --network mqtt_net \
    -v $(pwd)/scripts:/app/scripts myclient /app/scripts/entrypoint_client.sh 10 broker 8000 2
```

- The `launch.sh` script automates:
  - Network creation if it does not exist.
  - Building both images.
  - Running broker and clients in **tmux split panes** for live monitoring.

- Number of clients can be configured in the launch script parameters.

---

## Metrics Collection and Plotting

- `collect_metrics.sh` collects **CPU and network metrics** of the broker from outside the container.
- Metrics are stored in CSV files under `analysis/data/`.
- `plot_metrics.py` aggregates data by number of clients and generates plots with:
  - Mean CPU usage and standard deviation.
  - RX and TX network bytes with standard deviation.
  - Std values displayed directly in the plots.
- Plots are saved in `analysis/images/`.
- Install dependencies using `requirements.txt` (preferably in a virtual environment):

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r analysis/requirements.txt
```

- Run plotting script:

```bash
python3 analysis/plot_metrics.py
```

---

## Compilation and Execution

- Compile broker with `make`. Executable appears in `bin/broker`.
- Persistent state and logs are automatically handled via Docker volume mounts.
- Launch system via `launch.sh` to orchestrate broker and multiple clients.

---

## Limitations

- Only implements a **subset of MQTT 5.0** features.
- QoS > 0 not supported.
- No authentication.
- Simplified topic system (no wildcards).
- Debug mode must be enabled explicitly.
- Network metrics may vary depending on host system and number of clients.

---

This project provides a **hands-on experience** in implementing application-layer protocols, Docker container orchestration, and system metrics collection for educational purposes.